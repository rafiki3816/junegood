<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #fff;
            text-align: center;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gallery-container {
            display: none;
            position: relative;
            width: 100%;
            height: 100vh;
        }

        .gallery-container.loaded {
            display: block;
        }

        .main-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .main-image.loaded {
            opacity: 1;
        }

        .image-preloader {
            display: none;
        }

        .thumbnails {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            overflow-x: auto;
            max-width: 90%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
        }

        .thumbnails img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            border: 2px solid transparent;
        }

        .thumbnails img.active {
            opacity: 1;
            border-color: #fff;
        }

        .thumbnails img:hover {
            opacity: 1;
        }

        .thumbnails img.lazy {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            font-size: 30px;
            padding: 20px;
            cursor: pointer;
            transition: background 0.3s;
            z-index: 10;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .prev {
            left: 20px;
        }

        .next {
            right: 20px;
        }

        .photo-counter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
        }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            font-size: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
            z-index: 10;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 768px) {
            .nav-button {
                padding: 15px;
                font-size: 24px;
            }

            .thumbnails {
                bottom: 10px;
                padding: 5px;
            }

            .thumbnails img {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="loading">
        <div>Loading Gallery...</div>
        <div class="loading-spinner"></div>
        <div id="loading-progress" style="font-size: 14px; margin-top: 10px;"></div>
    </div>

    <div class="gallery-container">
        <button class="close-button" onclick="window.history.back()">×</button>
        <div class="photo-counter">
            <span id="current-photo">1</span> / <span id="total-photos">0</span>
        </div>

        <button class="nav-button prev" onclick="gallery.prevPhoto()">‹</button>
        <button class="nav-button next" onclick="gallery.nextPhoto()">›</button>

        <img id="main-image" class="main-image" alt="Gallery photo">

        <div class="thumbnails" id="thumbnails"></div>
    </div>

    <!-- Hidden image for preloading -->
    <img class="image-preloader" id="preloader">

    <script>
        class OptimizedGallery {
            constructor() {
                this.photos = [];
                this.currentIndex = 0;
                this.city = '';
                this.imageCache = new Map();
                this.loadedThumbnails = new Set();
                this.photoListCache = {};
                this.init();
            }

            async init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.city = urlParams.get('city');

                if (!this.city) {
                    document.querySelector('.loading').innerHTML = '<div>Error: No city specified</div>';
                    return;
                }

                document.title = `${this.city} - Photo Gallery`;

                // Try to get photo list from cache or scan
                await this.loadPhotosOptimized();

                if (this.photos.length > 0) {
                    this.setupGallery();
                    await this.showPhoto(0);

                    // Start preloading adjacent images
                    this.preloadAdjacentImages();

                    // Start lazy loading thumbnails
                    this.lazyLoadThumbnails();

                    document.querySelector('.loading').style.display = 'none';
                    document.querySelector('.gallery-container').classList.add('loaded');
                } else {
                    document.querySelector('.loading').innerHTML = '<div>No photos found</div>';
                }
            }

            async loadPhotosOptimized() {
                const basePath = `photos/${this.city}/img/`;
                const cacheKey = `gallery_${this.city}`;

                // Try to load from sessionStorage cache
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) {
                    this.photos = JSON.parse(cached);
                    document.getElementById('total-photos').textContent = this.photos.length;
                    return;
                }

                // Parallel checking with limited concurrent requests
                const checkLimit = 10; // Check 10 images at once
                const maxPhotos = 200; // Reduced from 500 for faster initial load
                let foundPhotos = [];
                let consecutiveMisses = 0;

                document.getElementById('loading-progress').textContent = 'Scanning photos...';

                // Use binary search approach to find the range
                const extensions = ['jpg', 'jpeg'];

                for (let i = 1; i <= maxPhotos; i += checkLimit) {
                    const batch = [];

                    for (let j = i; j < i + checkLimit && j <= maxPhotos; j++) {
                        for (const ext of extensions) {
                            batch.push(this.checkImageExistsFast(`${basePath}${j}.${ext}`, j, ext));
                        }
                    }

                    const results = await Promise.all(batch);
                    const validResults = results.filter(r => r !== null);

                    if (validResults.length > 0) {
                        foundPhotos.push(...validResults);
                        consecutiveMisses = 0;
                        document.getElementById('loading-progress').textContent = `Found ${foundPhotos.length} photos...`;
                    } else {
                        consecutiveMisses++;
                        // If we have photos and haven't found any in 3 batches, stop
                        if (foundPhotos.length > 0 && consecutiveMisses >= 3) {
                            break;
                        }
                    }
                }

                // Sort by index
                foundPhotos.sort((a, b) => a.index - b.index);
                this.photos = foundPhotos;

                // Cache the result
                sessionStorage.setItem(cacheKey, JSON.stringify(this.photos));

                document.getElementById('total-photos').textContent = this.photos.length;
            }

            checkImageExistsFast(url, index, ext) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => {
                        img.src = '';
                        resolve(null);
                    }, 3000); // 3 second timeout

                    img.onload = () => {
                        clearTimeout(timeout);
                        resolve({ src: url, index: index, ext: ext });
                    };
                    img.onerror = () => {
                        clearTimeout(timeout);
                        resolve(null);
                    };
                    img.src = url;
                });
            }

            setupGallery() {
                const thumbnailsContainer = document.getElementById('thumbnails');

                // Create placeholder thumbnails
                this.photos.forEach((photo, index) => {
                    const thumb = document.createElement('img');
                    thumb.className = 'lazy';
                    thumb.dataset.src = photo.src;
                    thumb.dataset.index = index;
                    thumb.alt = `Photo ${index + 1}`;
                    thumb.onclick = () => this.showPhoto(index);
                    thumbnailsContainer.appendChild(thumb);
                });

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') this.prevPhoto();
                    if (e.key === 'ArrowRight') this.nextPhoto();
                    if (e.key === 'Escape') window.history.back();
                });

                // Touch support
                let touchStartX = 0;
                const mainImage = document.getElementById('main-image');

                mainImage.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                });

                mainImage.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const diff = touchStartX - touchEndX;

                    if (Math.abs(diff) > 50) {
                        if (diff > 0) {
                            this.nextPhoto();
                        } else {
                            this.prevPhoto();
                        }
                    }
                });
            }

            lazyLoadThumbnails() {
                const thumbnails = document.querySelectorAll('.thumbnails img');
                const container = document.getElementById('thumbnails');

                // Load visible thumbnails first
                const loadVisibleThumbnails = () => {
                    const containerRect = container.getBoundingClientRect();

                    thumbnails.forEach(thumb => {
                        const rect = thumb.getBoundingClientRect();
                        const index = parseInt(thumb.dataset.index);

                        // Check if thumbnail is in or near viewport
                        if (rect.left < containerRect.right + 100 &&
                            rect.right > containerRect.left - 100 &&
                            !this.loadedThumbnails.has(index)) {

                            thumb.src = thumb.dataset.src;
                            thumb.classList.remove('lazy');
                            this.loadedThumbnails.add(index);
                        }
                    });
                };

                // Initial load
                loadVisibleThumbnails();

                // Load on scroll
                container.addEventListener('scroll', loadVisibleThumbnails);

                // Load thumbnails around current image
                this.loadNearbyThumbnails();
            }

            loadNearbyThumbnails() {
                const range = 5; // Load 5 thumbnails on each side
                const thumbnails = document.querySelectorAll('.thumbnails img');

                for (let i = Math.max(0, this.currentIndex - range);
                     i <= Math.min(this.photos.length - 1, this.currentIndex + range);
                     i++) {

                    const thumb = thumbnails[i];
                    if (thumb && !this.loadedThumbnails.has(i)) {
                        thumb.src = thumb.dataset.src;
                        thumb.classList.remove('lazy');
                        this.loadedThumbnails.add(i);
                    }
                }
            }

            async showPhoto(index) {
                if (index < 0 || index >= this.photos.length) return;

                this.currentIndex = index;
                const photo = this.photos[index];
                const mainImage = document.getElementById('main-image');

                // Update UI
                document.getElementById('current-photo').textContent = index + 1;

                // Update active thumbnail
                document.querySelectorAll('.thumbnails img').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                });

                // Scroll thumbnail into view
                const activeThumbnail = document.querySelectorAll('.thumbnails img')[index];
                if (activeThumbnail) {
                    activeThumbnail.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }

                // Show loading state
                mainImage.classList.remove('loaded');

                // Load from cache or fetch
                if (this.imageCache.has(photo.src)) {
                    mainImage.src = this.imageCache.get(photo.src);
                    mainImage.classList.add('loaded');
                } else {
                    // Load the image
                    const img = new Image();
                    img.onload = () => {
                        this.imageCache.set(photo.src, img.src);
                        mainImage.src = img.src;
                        mainImage.classList.add('loaded');
                    };
                    img.src = photo.src;
                }

                // Preload adjacent images
                this.preloadAdjacentImages();

                // Load nearby thumbnails
                this.loadNearbyThumbnails();
            }

            preloadAdjacentImages() {
                const preloadRange = 2; // Preload 2 images in each direction
                const preloader = document.getElementById('preloader');

                for (let i = -preloadRange; i <= preloadRange; i++) {
                    if (i === 0) continue; // Skip current image

                    const index = this.currentIndex + i;
                    if (index >= 0 && index < this.photos.length) {
                        const photo = this.photos[index];

                        if (!this.imageCache.has(photo.src)) {
                            const img = new Image();
                            img.onload = () => {
                                this.imageCache.set(photo.src, img.src);
                            };
                            img.src = photo.src;
                        }
                    }
                }
            }

            prevPhoto() {
                if (this.currentIndex > 0) {
                    this.showPhoto(this.currentIndex - 1);
                }
            }

            nextPhoto() {
                if (this.currentIndex < this.photos.length - 1) {
                    this.showPhoto(this.currentIndex + 1);
                }
            }
        }

        // Initialize gallery
        const gallery = new OptimizedGallery();
    </script>
</body>
</html>